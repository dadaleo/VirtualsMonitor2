<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alpha Sentinel - Persistent v8.0</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root {
            --bg: #05070a; --card-bg: #0f121a; --header-bg: rgba(5, 7, 10, 0.9);
            --accent-blue: #00d2ff; --accent-green: #00ff88; --accent-gold: #ffcc00;
            --accent-red: #ff3e3e; --text-main: #e0e6ed; --text-dim: #94a3b8;
            --border: #1e293b; --table-head: #161b22;
        }
        body { background: var(--bg); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 30px; }
        .header-nav { position: sticky; top: 0; z-index: 100; background: var(--header-bg); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        .mode-badge { background: rgba(0, 210, 255, 0.1); color: var(--accent-blue); padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; border: 1px solid var(--accent-blue); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 15px; padding: 15px; }
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 18px; position: relative; animation: fadeIn 0.3s ease; }
        .burn-value-display { background: var(--table-head); border-radius: 8px; padding: 12px; text-align: center; margin: 12px 0; }
        .usd-amount { font-size: 2rem; font-weight: 900; font-family: 'Consolas', monospace; color: var(--accent-green); }
        .stats-table { width: 100%; border-collapse: collapse; background: var(--card-bg); margin-top: 10px; }
        .stats-table th { background: var(--table-head); padding: 12px; text-align: left; font-size: 0.75rem; color: var(--text-dim); border-bottom: 1px solid var(--border); }
        .stats-table td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .btn-clear { background: #ff3e3e22; color: #ff3e3e; border: 1px solid #ff3e3e; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; }
        .hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <nav class="header-nav">
        <div>
            <h1 style="margin:0; font-size:1rem; color:var(--accent-blue);">ALPHA SENTINEL</h1>
            <div style="margin-top:4px;"><span class="mode-badge">ğŸ¯ æŒä¹…åŒ–ç›‘æ§æ¨¡å¼</span></div>
        </div>
        <button class="btn-clear" onclick="clearDatabase()">æ¸…ç©ºæœ¬åœ°æ•°æ®</button>
    </nav>

    <div style="padding: 15px 20px 0; display: flex; gap: 20px; border-bottom: 1px solid var(--border);">
        <button id="tabLive" onclick="switchTab('live')" style="background:none; border:none; color:var(--accent-blue); font-weight:bold; cursor:pointer; padding:10px 5px; border-bottom:2px solid var(--accent-blue);">å®æ—¶ç›‘æ§</button>
        <button id="tabStats" onclick="switchTab('stats')" style="background:none; border:none; color:var(--text-dim); font-weight:bold; cursor:pointer; padding:10px 5px;">é€šç¼©æ’è¡Œ</button>
    </div>

    <div id="liveView"><div id="grid" class="grid"></div></div>
    
    <div id="statsView" class="hidden" style="padding:15px; overflow-x: auto;">
        <table class="stats-table">
            <thead>
                <tr><th>ä»£å¸</th><th>å›è´­æ¬¡æ•°</th><th>æ€»ä»·å€¼(USD)</th><th>é€šç¼©æŒ‡æ•°</th></tr>
            </thead>
            <tbody id="statsBody"></tbody>
        </table>
    </div>

    <script>
        const socket = io();
        let allEvents = [];
        let tokenCache = {};

        // --- æœ¬åœ°å­˜å‚¨é€»è¾‘ ---
        function saveToLocal() {
            try {
                // ä»…ä¿ç•™æœ€è¿‘1000æ¡ï¼Œé˜²æ­¢æœ¬åœ°å­˜å‚¨æº¢å‡º
                const dataToSave = allEvents.slice(-1000);
                localStorage.setItem('alpha_sentinel_data', JSON.stringify(dataToSave));
            } catch (e) { console.error("æœ¬åœ°å­˜å‚¨å¤±è´¥", e); }
        }

        function loadFromLocal() {
            const saved = localStorage.getItem('alpha_sentinel_data');
            if (saved) {
                allEvents = JSON.parse(saved);
                console.log(`å·²ä»æœ¬åœ°æ¢å¤ ${allEvents.length} æ¡æ•°æ®`);
                // æ¢å¤åç«‹å³æ¸²æŸ“ä¸€æ¬¡ï¼Œç‰¹åˆ«æ˜¯å¦‚æœæ˜¯åˆšå¼€ç½‘é¡µ
                allEvents.forEach(e => {
                    if (e.usd >= 100) renderCard(e, false); // false è¡¨ç¤ºä¸ç½®é¡¶ï¼ŒæŒ‰é¡ºåºæ’
                });
                renderStats();
            }
        }

        function clearDatabase() {
            if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœ¬åœ°å†å²æ•°æ®å’Œæ’è¡Œæ¦œå—ï¼Ÿ")) {
                localStorage.removeItem('alpha_sentinel_data');
                allEvents = [];
                document.getElementById('grid').innerHTML = '';
                renderStats();
            }
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---
        function switchTab(mode) {
            const isL = mode === 'live';
            document.getElementById('liveView').classList.toggle('hidden', !isL);
            document.getElementById('statsView').classList.toggle('hidden', isL);
            document.getElementById('tabLive').style.color = isL ? 'var(--accent-blue)' : 'var(--text-dim)';
            document.getElementById('tabLive').style.borderBottom = isL ? '2px solid var(--accent-blue)' : 'none';
            document.getElementById('tabStats').style.color = !isL ? 'var(--accent-blue)' : 'var(--text-dim)';
            document.getElementById('tabStats').style.borderBottom = !isL ? '2px solid var(--accent-blue)' : 'none';
            if(!isL) renderStats();
        }

        async function getDex(addr) {
            if(tokenCache[addr]) return tokenCache[addr];
            try {
                const r = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${addr}`);
                const d = await r.json();
                const p = d.pairs ? d.pairs[0] : null;
                tokenCache[addr] = {
                    symbol: p ? p.baseToken.symbol : 'UNK',
                    fdv: p ? parseFloat(p.fdv || 0) : 0,
                    price: p ? parseFloat(p.priceUsd || 0) : 0
                };
                return tokenCache[addr];
            } catch { return { symbol: 'N/A', fdv: 0, price: 0 }; }
        }

        function renderCard(data, isNew = true) {
            if (document.getElementById(data.tx)) return; // å½»åº•æ’é‡

            const card = document.createElement('div');
            card.className = 'card';
            card.id = data.tx;
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <b style="font-size:1.1rem; color:var(--accent-blue);">${data.symbol}</b>
                        <div style="font-size:0.7rem; color:var(--text-dim);">å¸‚å€¼: $${data.fdv.toLocaleString()}</div>
                    </div>
                    <span style="font-size:0.65rem; color:var(--text-dim);">${data.time}</span>
                </div>
                <div class="burn-value-display">
                    <div class="usd-amount">$${data.usd.toLocaleString(undefined,{minimumFractionDigits:2})}</div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:0.75rem;">
                    <span style="color:var(--accent-gold); font-weight:bold;">${data.usd > 500 ? 'ğŸ”¥ WHALE' : 'âœ… VERIFIED'}</span>
                    <span>IMPACT: <span style="color:var(--accent-red);">${data.impact}%</span></span>
                </div>
                <div style="margin-top:12px; border-top:1px solid var(--border); padding-top:8px; text-align:right;">
                    <a href="https://basescan.org/tx/${data.tx}" target="_blank" style="color:var(--accent-dim); text-decoration:none; font-size:0.7rem;">æŸ¥çœ‹å“ˆå¸Œ â†’</a>
                </div>
            `;
            const grid = document.getElementById('grid');
            if (isNew) grid.insertBefore(card, grid.firstChild);
            else grid.appendChild(card);
        }

        socket.on('new_burn_event', async (data) => {
            // å…ˆæ’é‡ï¼Œé¿å…é‡å¤è®¡ç®—
            if (allEvents.some(e => e.tx === data.tx)) return;

            const dex = await getDex(data.token);
            const qty = parseFloat(data.amount.replace(/,/g, ''));
            let usd = qty * (dex.price || 0);
            
            // é“¾ä¸Šå…œåº•é€»è¾‘
            if(usd === 0 && data.weth_reserve > 0) {
                usd = qty * (data.weth_reserve / parseFloat(data.reserve.replace(/,/g, ''))) * 2650;
            }

            const eventData = {...data, ...dex, usd, qty};
            allEvents.push(eventData);
            
            // å­˜å…¥æœ¬åœ°å­˜å‚¨
            saveToLocal();

            // ä»…å±•ç¤º > 100 çš„å¡ç‰‡
            if (usd >= 100) {
                renderCard(eventData, true);
            }
            
            // å®æ—¶æ›´æ–°ä¸€æ¬¡æ’è¡Œæ¦œ
            if (document.getElementById('statsView').className === '') renderStats();
        });

        function renderStats() {
            const s = {};
            allEvents.forEach(e => {
                if(!s[e.token]) s[e.token] = { sym: e.symbol, count: 0, total: 0, fdv: e.fdv };
                s[e.token].count++;
                s[e.token].total += e.usd;
            });
            const sorted = Object.entries(s).sort((a,b) => b[1].total - a[1].total);
            document.getElementById('statsBody').innerHTML = sorted.map(([addr, d]) => {
                const intensity = d.fdv > 0 ? ((d.total / d.fdv) * 100).toFixed(4) : "0.0000";
                return `<tr>
                    <td><b>${d.sym}</b></td>
                    <td>${d.count}</td>
                    <td style="color:var(--accent-green); font-weight:bold;">$${d.total.toLocaleString(undefined,{maximumFractionDigits:0})}</td>
                    <td style="color:var(--accent-gold);">${intensity}</td>
                </tr>`
            }).join('');
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        window.onload = loadFromLocal;
    </script>
</body>
</html>