<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alpha Sentinel - Persistent v9.0</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root {
            --bg: #05070a; --card-bg: #0f121a; --header-bg: rgba(5, 7, 10, 0.95);
            --accent-blue: #00d2ff; --accent-green: #00ff88; --accent-gold: #ffcc00;
            --accent-red: #ff3e3e; --text-main: #e0e6ed; --text-dim: #94a3b8;
            --border: #1e293b; --table-head: #161b22;
        }
        body { background: var(--bg); color: var(--text-main); font-family: 'Inter', system-ui, sans-serif; margin: 0; padding-bottom: 20px; }
        
        .header-nav { position: sticky; top: 0; z-index: 100; background: var(--header-bg); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); padding: 12px 15px; }
        .nav-flex { display: flex; justify-content: space-between; align-items: center; }
        
        .filter-box { display: flex; align-items: center; gap: 8px; background: var(--table-head); padding: 5px 12px; border-radius: 8px; border: 1px solid var(--border); }
        .filter-box input { background: transparent; border: none; color: var(--accent-green); width: 50px; outline: none; font-weight: bold; font-family: monospace; font-size: 1rem; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 15px; padding: 15px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 18px; border: 1px solid var(--border); transition: 0.3s; position: relative; animation: fadeIn 0.3s ease; }
        
        .tag { font-size: 0.65rem; font-weight: 800; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; }
        .tag-blue { background: rgba(0, 210, 255, 0.1); color: var(--accent-blue); border: 1px solid var(--accent-blue); }
        .tag-gold { background: rgba(255, 204, 0, 0.1); color: var(--accent-gold); border: 1px solid var(--accent-gold); }
        
        .burn-value-box { background: var(--table-head); border-radius: 8px; padding: 15px; text-align: center; margin: 12px 0; border: 1px solid var(--border); }
        .usd-val { font-size: 2.2rem; font-weight: 900; font-family: 'Consolas', monospace; }
        
        .stats-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .stats-table th { text-align: left; padding: 12px; color: var(--text-dim); background: var(--table-head); }
        .stats-table td { padding: 12px; border-bottom: 1px solid var(--border); }
        
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <nav class="header-nav">
        <div class="nav-flex">
            <h1 style="margin:0; font-size:1.1rem; color:var(--accent-blue); letter-spacing:1px;">SENTINEL V9</h1>
            <div class="filter-box">
                <span style="font-size:0.6rem; color:var(--text-dim);">MIN USD $</span>
                <input type="number" id="minUsd" value="100" oninput="saveSettings()">
            </div>
        </div>
    </nav>

    <div style="padding: 10px 15px 0; display: flex; gap: 20px; align-items: center;">
        <button id="btnLive" onclick="switchTab('live')" style="background:none; border:none; color:var(--accent-blue); font-weight:bold; cursor:pointer; padding:10px; border-bottom:2px solid var(--accent-blue);">ÂÆûÊó∂ÁõëÊéß</button>
        <button id="btnStats" onclick="switchTab('stats')" style="background:none; border:none; color:var(--text-dim); font-weight:bold; cursor:pointer; padding:10px;">ÊéíË°åÊ¶ú</button>
        <span id="connStatus" style="font-size:0.6rem; color:#555; margin-left:auto;">Á≠âÂæÖËøûÊé•...</span>
        <button onclick="clearData()" style="background:none; border:none; color:var(--accent-red); font-size:0.7rem; cursor:pointer; padding:10px;">Ê∏ÖÁ©∫</button>
    </div>

    <div id="liveView"><div id="grid" class="grid"></div></div>
    
    <div id="statsView" class="hidden" style="padding:15px; overflow-x: auto;">
        <table class="stats-table">
            <thead><tr><th>‰ª£Â∏Å</th><th>Ê¨°Êï∞</th><th>Á¥ØËÆ°USD</th><th>ÈÄöÁº©ÊåáÊï∞</th></tr></thead>
            <tbody id="statsBody"></tbody>
        </table>
    </div>

    <script>
        const socket = io();
        let allEvents = [];
        let tokenCache = {};

        // --- Ê†∏ÂøÉÔºöÈ°µÈù¢Âä†ËΩΩÈÄªËæë ---
        window.onload = function() {
            // 1. Âä†ËΩΩÈÖçÁΩÆ
            const savedMin = localStorage.getItem('min_usd_v9');
            if(savedMin) document.getElementById('minUsd').value = savedMin;

            // 2. Âº∫Ë°åÂÖàÊ∏≤ÊüìÊú¨Âú∞Êï∞ÊçÆ
            const savedEvents = localStorage.getItem('burn_events_v9');
            if(savedEvents) {
                allEvents = JSON.parse(savedEvents);
                console.log("‰ªéÁºìÂ≠òÊÅ¢Â§çÊï∞ÊçÆÈáè:", allEvents.length);
                // ÊåâÊó∂Èó¥È°∫Â∫èÊ∏≤ÊüìËÄÅÊï∞ÊçÆÔºà‰∏çÁΩÆÈ°∂Ôºâ
                allEvents.forEach(e => renderCard(e, false));
                applyFilter();
                renderStats();
            }
        };

        // --- Êï∞ÊçÆÊåÅ‰πÖÂåñ ---
        function saveSettings() {
            localStorage.setItem('min_usd_v9', document.getElementById('minUsd').value);
            applyFilter();
        }

        function saveEvents() {
            // Âè™‰øùÁïôÊúÄËøë 1000 Êù°ÔºåÁ°Æ‰øùÊâãÊú∫ÊµèËßàÂô®‰∏çÂç°È°ø
            localStorage.setItem('burn_events_v9', JSON.stringify(allEvents.slice(-1000)));
        }

        function clearData() {
            if(confirm("Á°ÆÂÆöÊ∏ÖÁ©∫ÊâÄÊúâÊú¨Âú∞ÂéÜÂè≤Êï∞ÊçÆÂêóÔºü")) {
                localStorage.clear();
                allEvents = [];
                document.getElementById('grid').innerHTML = '';
                renderStats();
                location.reload();
            }
        }

        function applyFilter() {
            const min = parseFloat(document.getElementById('minUsd').value) || 0;
            document.querySelectorAll('.card').forEach(c => {
                const val = parseFloat(c.dataset.usd);
                c.classList.toggle('hidden', val < min);
            });
        }

        function switchTab(t) {
            const isLive = t === 'live';
            document.getElementById('liveView').classList.toggle('hidden', !isLive);
            document.getElementById('statsView').classList.toggle('hidden', isLive);
            document.getElementById('btnLive').style.color = isLive ? 'var(--accent-blue)' : 'var(--text-dim)';
            document.getElementById('btnLive').style.borderBottom = isLive ? '2px solid var(--accent-blue)' : 'none';
            document.getElementById('btnStats').style.color = !isLive ? 'var(--accent-blue)' : 'var(--text-dim)';
            document.getElementById('btnStats').style.borderBottom = !isLive ? '2px solid var(--accent-blue)' : 'none';
            if(!isLive) renderStats();
        }

        async function getDex(addr) {
            if(tokenCache[addr]) return tokenCache[addr];
            try {
                const r = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${addr}`);
                const d = await r.json();
                const p = d.pairs ? d.pairs[0] : null;
                tokenCache[addr] = {
                    symbol: p ? p.baseToken.symbol : 'UNK',
                    fdv: p ? parseFloat(p.fdv || 0) : 0,
                    price: p ? parseFloat(p.priceUsd || 0) : 0
                };
                return tokenCache[addr];
            } catch { return { symbol: 'N/A', fdv: 0, price: 0 }; }
        }

        function renderCard(e, isNew = true) {
            if(document.getElementById(e.tx)) return; // ‰∏•Ê†ºÊéíÈáç

            const usd = parseFloat(e.usd) || 0;
            const card = document.createElement('div');
            card.className = 'card';
            card.id = e.tx;
            card.dataset.usd = usd;

            let tag = '';
            if (usd >= 500) {
                tag = '<span class="tag tag-gold">üî• WHALE ACTION</span>';
                card.style.borderColor = 'var(--accent-gold)';
            } else if (usd >= 100) {
                tag = '<span class="tag tag-blue">‚úÖ VERIFIED BURN</span>';
                card.style.borderColor = 'var(--accent-blue)';
            } else {
                tag = '<span class="tag" style="background:#222; color:#666;">Low Impact</span>';
            }

            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div><b style="font-size:1.1rem; color:var(--accent-blue);">${e.symbol}</b><br><small style="color:var(--text-dim);">Â∏ÇÂÄº: $${e.fdv.toLocaleString()}</small></div>
                    <span style="font-size:0.65rem; color:var(--text-dim);">${e.time}</span>
                </div>
                <div class="burn-value-box">
                    <div class="usd-val" style="color:${usd >= 100 ? 'var(--accent-green)' : '#fff'}">$${usd.toLocaleString(undefined,{minimumFractionDigits:2})}</div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    ${tag}
                    <div style="font-size:0.75rem; color:var(--text-dim);">Impact: <span style="color:${e.impact > 1 ? 'var(--accent-red)' : 'var(--accent-green)'}">${e.impact}%</span></div>
                </div>
                <div style="margin-top:12px; padding-top:10px; border-top:1px solid var(--border); text-align:right;">
                    <a href="https://basescan.org/tx/${e.tx}" target="_blank" style="color:var(--text-dim); text-decoration:none; font-size:0.7rem;">HASH ‚Üó</a>
                </div>
            `;
            const g = document.getElementById('grid');
            if(isNew) g.insertBefore(card, g.firstChild); // Êñ∞Êù•ÁöÑÊîæÊúÄ‰∏äÈù¢
            else g.appendChild(card); // ÊÅ¢Â§çËÄÅÊï∞ÊçÆÊîæÂêéÈù¢
        }

        // --- Socket Êé•Êî∂‰∏éÊéíÈáç ---
        socket.on('connect', () => {
            document.getElementById('connStatus').innerText = "‚óè Â∑≤ËøûÊé•";
            document.getElementById('connStatus').style.color = "var(--accent-green)";
        });

        socket.on('new_burn_event', async (data) => {
            // ÂÖ≥ÈîÆÔºöÂ¶ÇÊûúÊú¨Âú∞Â∑≤ÁªèÊúâ‰∫ÜÔºàÊØîÂ¶ÇÂàöÊâçÂ≠òËøáÁöÑÔºâÔºåÁõ¥Êé•Êó†ËßÜË°•ÂèëÁöÑÊï∞ÊçÆ
            if(allEvents.some(x => x.tx === data.tx)) return;

            const dex = await getDex(data.token);
            const qty = parseFloat(data.amount.replace(/,/g, ''));
            let usd = qty * (dex.price || 0);
            
            if(usd === 0 && data.weth_reserve > 0) {
                usd = qty * (data.weth_reserve / parseFloat(data.reserve.replace(/,/g, ''))) * 2650;
            }

            const fullData = {...data, ...dex, usd, qty};
            allEvents.push(fullData);
            saveEvents();
            
            renderCard(fullData, true); // ÂÆûÊó∂Êé®ÈÄÅÔºåÊèíÂÖ•È°∂ÈÉ®
            applyFilter();
        });

        function renderStats() {
            const s = {};
            allEvents.forEach(e => {
                if(!s[e.token]) s[e.token] = { sym: e.symbol, count: 0, total: 0, fdv: e.fdv };
                s[e.token].count++; s[e.token].total += e.usd;
            });
            const sorted = Object.entries(s).sort((a,b) => b[1].total - a[1].total);
            document.getElementById('statsBody').innerHTML = sorted.map(([addr, d]) => `
                <tr><td><b>${d.sym}</b></td><td>${d.count}</td><td style="color:var(--accent-green); font-weight:bold;">$${d.total.toLocaleString(undefined,{maximumFractionDigits:0})}</td><td>${d.fdv > 0 ? ((d.total / d.fdv) * 100).toFixed(4) : "0.000"}</td></tr>
            `).join('');
        }
    </script>
</body>
</html>